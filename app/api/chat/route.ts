import { NextRequest, NextResponse } from 'next/server'
import OpenAI from 'openai'

// OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || '',
})

// 1ì¸ ê°€êµ¬ ë©˜íƒˆ ì¼€ì–´ì— íŠ¹í™”ëœ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ 1ì¸ ê°€êµ¬ë¥¼ ìœ„í•œ ì „ë¬¸ AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ì§€ì¹¨ì„ ë”°ë¼ ìƒë‹´ì„ ì§„í–‰í•´ì£¼ì„¸ìš”:

**ì—­í• ê³¼ íŠ¹ì„±:**
- ë”°ëœ»í•˜ê³  ê³µê°ì ì¸ ì–´ì¡°ë¡œ ëŒ€í™”
- 1ì¸ ê°€êµ¬ì˜ ê³ ìœ í•œ ì–´ë ¤ì›€(ì™¸ë¡œì›€, ë¶ˆì•ˆ, ìŠ¤íŠ¸ë ˆìŠ¤ ë“±)ì— ëŒ€í•œ ê¹Šì€ ì´í•´
- ë¹„íŒì ì´ì§€ ì•Šê³  ìˆ˜ìš©ì ì¸ íƒœë„
- ì „ë¬¸ì ì´ì§€ë§Œ ì¹œê·¼í•œ ìƒë‹´ ìŠ¤íƒ€ì¼

**ìƒë‹´ ì›ì¹™:**
1. ë¨¼ì € ê°ì •ì„ ì¶©ë¶„íˆ ë“¤ì–´ì£¼ê³  ê³µê°í•˜ê¸°
2. 1ì¸ ê°€êµ¬ íŠ¹ì„±ì„ ê³ ë ¤í•œ í˜„ì‹¤ì ì¸ ì¡°ì–¸ ì œê³µ
3. ì‘ì€ ë³€í™”ë¶€í„° ì‹œì‘í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë°©ë²• ì œì•ˆ
4. í•„ìš”ì‹œ ì „ë¬¸ê°€ ë„ì›€ì´ë‚˜ ì‘ê¸‰ìƒí™© ëŒ€ì‘ ì•ˆë‚´
5. í˜¼ìê°€ ì•„ë‹ˆë¼ëŠ” ê²ƒì„ ëŠë¼ê²Œ í•´ì£¼ê¸°

**ëŒ€í™” ìŠ¤íƒ€ì¼:**
- í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”
- ë„ˆë¬´ ê¸¸ì§€ ì•Šì€ ì ì ˆí•œ ê¸¸ì´ì˜ ì‘ë‹µ
- ì§ˆë¬¸ì„ í†µí•´ ë” ê¹Šì´ íƒìƒ‰í•˜ë„ë¡ ìœ ë„
- ë”°ëœ»í•œ ê²©ë ¤ì™€ ì§€ì§€ í‘œí˜„

**ì£¼ì˜ì‚¬í•­:**
- ì˜í•™ì  ì§„ë‹¨ì´ë‚˜ ì²˜ë°©ì€ ì ˆëŒ€ í•˜ì§€ ì•Šê¸°
- ì‹¬ê°í•œ ìí•´ë‚˜ ìì‚´ ìœ„í—˜ ì§•í›„ ì‹œ ì¦‰ì‹œ ì „ë¬¸ê°€ ë„ì›€ ê¶Œìœ 
- ê°œì¸ì •ë³´ë‚˜ ë¯¼ê°í•œ ì •ë³´ ìš”êµ¬í•˜ì§€ ì•Šê¸°

**ì‘ê¸‰ìƒí™© ëŒ€ì‘:**
ìì‚´ì´ë‚˜ ìí•´ ìœ„í—˜ì´ ê°ì§€ë˜ë©´ ì¦‰ì‹œ ë‹¤ìŒì„ ì•ˆë‚´:
- 24ì‹œê°„ ìœ„ê¸°ìƒë‹´ì „í™”: 1393
- ì‘ê¸‰ì‹¤: 119
- "ì§€ê¸ˆ ë‹¹ì¥ ì•ˆì „í•œ ê³³ì— ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , í˜¼ì ìˆì§€ ë§ê³  ëˆ„êµ°ê°€ì—ê²Œ ì—°ë½í•˜ì„¸ìš”"

ì§€ê¸ˆë¶€í„° 1ì¸ ê°€êµ¬ë¥¼ ìœ„í•œ ë§ˆìŒ ëŒë´„ ìƒë‹´ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.`

// ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œìš© ì‘ë‹µ ìƒì„± í•¨ìˆ˜
function getSimulatedResponse(userInput: string): string {
  const input = userInput.toLowerCase()
  
  // ê°ì • í‚¤ì›Œë“œ ê°ì§€
  if (input.includes('ì™¸ë¡­') || input.includes('í˜¼ì') || input.includes('ì“¸ì“¸')) {
    const responses = [
      'í˜¼ì ìˆëŠ” ì‹œê°„ì´ ë§ì•„ì„œ ì™¸ë¡œì›€ì„ ëŠë¼ì‹œëŠ”êµ°ìš”. ê·¸ëŸ° ë§ˆìŒì´ ë“œëŠ” ê²ƒì€ ìì—°ìŠ¤ëŸ¬ìš´ ì¼ì´ì—ìš”. 1ì¸ ê°€êµ¬ë¡œ ìƒí™œí•˜ë©´ì„œ ì´ëŸ° ê°ì •ì„ ê²½í—˜í•˜ëŠ” ë¶„ë“¤ì´ ì •ë§ ë§ì•„ìš”. í‰ì†Œì— ì–´ë–¤ í™œë™ì„ í•˜ì‹¤ ë•Œ ë§ˆìŒì´ ì¡°ê¸ˆì´ë¼ë„ í¸í•´ì§€ì‹œë‚˜ìš”?',
      'ì™¸ë¡œì›€ì„ ëŠë¼ê³  ê³„ì‹œëŠ”êµ°ìš”. í˜¼ì ìˆë‹¤ê³  í•´ì„œ ì •ë§ í˜¼ìì¸ ê±´ ì•„ë‹ˆì—ìš”. ì§€ê¸ˆ ì´ë ‡ê²Œ ë§ˆìŒì„ ë‚˜ëˆ„ê³  ìˆì–ì•„ìš”. ì‘ì€ ê²ƒë¶€í„° ì‹œì‘í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”? ì¢‹ì•„í•˜ëŠ” ìŒì•…ì„ ë“£ê±°ë‚˜, ì‚°ì±…ì„ í•˜ê±°ë‚˜, ì˜¨ë¼ì¸ ì»¤ë®¤ë‹ˆí‹°ì— ì°¸ì—¬í•´ë³´ì‹œëŠ” ê²ƒë„ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”.',
      '1ì¸ ê°€êµ¬ë¡œ ìƒí™œí•˜ë©´ì„œ ì™¸ë¡œì›€ì„ ëŠë¼ëŠ” ê²ƒì€ ë‹¹ì—°í•œ ê°ì •ì´ì—ìš”. ìì‹ ì„ íƒ“í•˜ì§€ ë§ˆì„¸ìš”. í˜¹ì‹œ ê°€ì¡±ì´ë‚˜ ì¹œêµ¬ë“¤ê³¼ ì—°ë½ì„ ì·¨í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆì„ê¹Œìš”? ì•„ë‹ˆë©´ ìƒˆë¡œìš´ ì‚¬ëŒë“¤ê³¼ ë§Œë‚  ìˆ˜ ìˆëŠ” ì·¨ë¯¸í™œë™ì´ë‚˜ ëª¨ì„ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹ ê°€ìš”?'
    ]
    return responses[Math.floor(Math.random() * responses.length)]
  }
  
  if (input.includes('ìš°ìš¸') || input.includes('ìŠ¬í”„') || input.includes('ê¸°ë¶„ì´ ì•ˆ')) {
    const responses = [
      'ë§ˆìŒì´ ë§ì´ ìš°ìš¸í•˜ì‹œêµ°ìš”. ê·¸ëŸ° ê¸°ë¶„ì´ ë“œëŠ” ê²ƒì€ ì¶©ë¶„íˆ ì´í•´í•  ìˆ˜ ìˆì–´ìš”. í˜¼ì ëª¨ë“  ê²ƒì„ ê°ë‹¹í•˜ë ¤ê³  í•˜ë©´ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”. ì–¸ì œë¶€í„° ì´ëŸ° ê¸°ë¶„ì´ ë“œì…¨ë‚˜ìš”? íŠ¹ë³„í•œ ì´ìœ ê°€ ìˆìœ¼ì…¨ì„ê¹Œìš”?',
      'ìŠ¬í”ˆ ë§ˆìŒì„ í‘œí˜„í•´ì£¼ì…”ì„œ ê³ ë§ˆì›Œìš”. ê°ì •ì„ ìˆ¨ê¸°ì§€ ì•Šê³  ë§ì”€í•´ì£¼ì‹œëŠ” ê²ƒë§Œìœ¼ë¡œë„ ìš©ê¸° ìˆëŠ” ì¼ì´ì—ìš”. ìš°ìš¸í•œ ê¸°ë¶„ì´ ê³„ì† ì§€ì†ë˜ê³  ìˆë‚˜ìš”? ì¼ìƒìƒí™œì—ì„œ ì¡°ê¸ˆì´ë¼ë„ ê¸°ë¶„ì´ ë‚˜ì•„ì§€ëŠ” ìˆœê°„ë“¤ì´ ìˆë‚˜ìš”?',
      'ê¸°ë¶„ì´ ì•ˆ ì¢‹ìœ¼ì‹œëŠ”êµ°ìš”. 1ì¸ ê°€êµ¬ë¡œ ìƒí™œí•˜ë©´ì„œ ì´ëŸ° ê°ì •ë“¤ì´ ë” í¬ê²Œ ëŠê»´ì§ˆ ìˆ˜ ìˆì–´ìš”. í˜¼ìì„œ ëª¨ë“  ê±¸ í•´ê²°í•˜ë ¤ê³  í•˜ì§€ ë§ˆì„¸ìš”. ì‘ì€ ë³€í™”ë¶€í„° ì‹œì‘í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”? ê·œì¹™ì ì¸ ìˆ˜ë©´ì´ë‚˜ ê°€ë²¼ìš´ ìš´ë™ë„ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”.'
    ]
    return responses[Math.floor(Math.random() * responses.length)]
  }
  
  if (input.includes('ìŠ¤íŠ¸ë ˆìŠ¤') || input.includes('í˜ë“¤') || input.includes('ì§€ì³')) {
    const responses = [
      'ë§ì€ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ê³  ê³„ì‹œëŠ” ê²ƒ ê°™ë„¤ìš”. 1ì¸ ê°€êµ¬ë¡œ ìƒí™œí•˜ë©´ì„œ ëª¨ë“  ê²ƒì„ í˜¼ì ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ë¶€ë‹´ê°ì´ í´ í…ë°ìš”. ì–´ë–¤ ë¶€ë¶„ì—ì„œ ê°€ì¥ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ê³  ê³„ì‹ ê°€ìš”? êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì‹œë©´ í•¨ê»˜ í•´ê²°ë°©ë²•ì„ ì°¾ì•„ë³¼ ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”.',
      'ì •ë§ í˜ë“  ì‹œê°„ì„ ë³´ë‚´ê³  ê³„ì‹œëŠ”êµ°ìš”. í˜¼ìì„œ ëª¨ë“  ê±¸ ê°ë‹¹í•˜ë ¤ê³  í•˜ë‹ˆ ì§€ì¹˜ëŠ” ê²ƒì€ ë‹¹ì—°í•´ìš”. ì™„ë²½í•˜ê²Œ í•˜ë ¤ê³  í•˜ì§€ ë§ˆì‹œê³ , ë•Œë¡œëŠ” ë„ì›€ì„ ìš”ì²­í•˜ëŠ” ê²ƒë„ í•„ìš”í•´ìš”. í‰ì†Œì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í’€ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆìœ¼ì‹ ê°€ìš”?',
      'ì§€ì³ìˆìœ¼ì‹  ë§ˆìŒì´ ëŠê»´ì ¸ìš”. ì¶©ë¶„íˆ í˜ë“œì…¨ì„ ê±°ì˜ˆìš”. ì§€ê¸ˆê¹Œì§€ ì •ë§ ì˜ ë²„í…¨ì˜¤ì‹  ê±°ì˜ˆìš”. ì ì‹œ ìˆ¨ì„ ê³ ë¥´ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”? ì¢‹ì•„í•˜ëŠ” ê²ƒë“¤ì„ ë‹¤ì‹œ ìƒê°í•´ë³´ì‹œê³ , ì‘ì€ ê²ƒì´ë¼ë„ ìì‹ ì—ê²Œ ì„ ë¬¼í•˜ëŠ” ì‹œê°„ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.'
    ]
    return responses[Math.floor(Math.random() * responses.length)]
  }
  
  if (input.includes('ë¶ˆì•ˆ') || input.includes('ê±±ì •') || input.includes('ë¬´ì„œ')) {
    const responses = [
      'ë¶ˆì•ˆí•œ ë§ˆìŒì´ ë“œì‹œëŠ”êµ°ìš”. 1ì¸ ê°€êµ¬ë¡œ ìƒí™œí•˜ë©´ì„œ ë¯¸ë˜ì— ëŒ€í•œ ê±±ì •ì´ë‚˜ í˜¼ì ìˆëŠ” ê²ƒì— ëŒ€í•œ ë¶ˆì•ˆê°ì„ ëŠë¼ëŠ” ê²ƒì€ ìì—°ìŠ¤ëŸ¬ìš´ ì¼ì´ì—ìš”. ì–´ë–¤ ë¶€ë¶„ì´ ê°€ì¥ ë¶ˆì•ˆí•˜ê²Œ ëŠê»´ì§€ì‹œë‚˜ìš”?',
      'ê±±ì •ì´ ë§ìœ¼ì‹  ê²ƒ ê°™ì•„ìš”. í˜¼ìì„œ ëª¨ë“  ê²ƒì„ ì±…ì„ì ¸ì•¼ í•œë‹¤ëŠ” ë¶€ë‹´ê° ë•Œë¬¸ì— ë” ë¶ˆì•ˆí•´ì§ˆ ìˆ˜ ìˆì–´ìš”. ì§€ê¸ˆ ë‹¹ì¥ í•´ê²°í•  ìˆ˜ ìˆëŠ” ê²ƒê³¼ ì—†ëŠ” ê²ƒì„ ë‚˜ëˆ„ì–´ì„œ ìƒê°í•´ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”?',
      'ë¬´ì„œìš´ ë§ˆìŒì´ ë“œì‹œëŠ”êµ°ìš”. ê·¸ëŸ° ê°ì •ì„ ëŠë¼ëŠ” ê²ƒì€ ì˜ëª»ëœ ê²Œ ì•„ë‹ˆì—ìš”. ë¶ˆì•ˆí•  ë•Œ ë„ì›€ì´ ë˜ëŠ” í˜¸í¡ë²•ì´ë‚˜ ì´ì™„ê¸°ë²•ì„ ì‹œë„í•´ë³´ì‹  ì ì´ ìˆë‚˜ìš”? ì•„ë‹ˆë©´ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒê³¼ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆì„ê¹Œìš”?'
    ]
    return responses[Math.floor(Math.random() * responses.length)]
  }
  
  if (input.includes('ì•ˆë…•') || input.includes('ì²˜ìŒ') || input.includes('ì‹œì‘')) {
    return 'ì•ˆë…•í•˜ì„¸ìš”! ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”. ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë– ì„¸ìš”? 1ì¸ ê°€êµ¬ë¡œ ìƒí™œí•˜ì‹œë©´ì„œ ì–´ë–¤ ë§ˆìŒì´ ë“œì‹œëŠ”ì§€ í¸ì•ˆí•˜ê²Œ ë§ì”€í•´ ì£¼ì„¸ìš”. ì–´ë–¤ ì´ì•¼ê¸°ë“  ë“¤ì„ ì¤€ë¹„ê°€ ë˜ì–´ìˆì–´ìš”. ğŸ˜Š'
  }
  
  if (input.includes('ë„ì›€') || input.includes('ì¡°ì–¸') || input.includes('ì–´ë–»ê²Œ')) {
    return 'ë„ì›€ì´ í•„ìš”í•˜ì‹œêµ°ìš”. êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë¶€ë¶„ì—ì„œ ë„ì›€ì´ í•„ìš”í•˜ì‹ ì§€ ë§ì”€í•´ ì£¼ì‹œë©´, 1ì¸ ê°€êµ¬ ìƒí™©ì— ë§ëŠ” í˜„ì‹¤ì ì¸ ì¡°ì–¸ì„ ë“œë¦´ ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”. ì‘ì€ ê²ƒë¶€í„° ì°¨ê·¼ì°¨ê·¼ í•´ê²°í•´ ë‚˜ê°€ë³´ì•„ìš”.'
  }
  
  // ìì‚´/ìí•´ ê´€ë ¨ í‚¤ì›Œë“œ ê°ì§€
  if (input.includes('ì£½ê³ ì‹¶') || input.includes('ìì‚´') || input.includes('ëë‚´ê³ ì‹¶') || input.includes('ì‚´ê¸°ì‹«')) {
    return 'ì§€ê¸ˆ ì •ë§ í˜ë“  ìƒí™©ì´ì‹  ê²ƒ ê°™ì•„ìš”. ì´ëŸ° ìƒê°ì´ ë“œì‹œëŠ” ê²ƒì´ ì–¼ë§ˆë‚˜ ê³ í†µìŠ¤ëŸ¬ìš°ì‹¤ì§€ ì´í•´í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ í˜¼ì ê²¬ë””ì§€ ë§ˆì‹œê³  ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì…¨ìœ¼ë©´ í•´ìš”. 24ì‹œê°„ ìœ„ê¸°ìƒë‹´ì „í™” 1393ìœ¼ë¡œ ì—°ë½í•˜ì‹œê±°ë‚˜, ì‘ê¸‰ìƒí™©ì´ì‹œë©´ 119ë¡œ ì—°ë½í•´ ì£¼ì„¸ìš”. ì§€ê¸ˆ ì•ˆì „í•œ ê³³ì— ê³„ì‹ ê°€ìš”?'
  }
  
  // ê¸°ë³¸ ì‘ë‹µë“¤
  const generalResponses = [
    'ê·¸ëŸ° ë§ˆìŒì´ ë“œì‹œëŠ”êµ°ìš”. ì¢€ ë” ìì„¸íˆ ë§ì”€í•´ ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”? ì–´ë–¤ ìƒí™©ì—ì„œ ê·¸ëŸ° ìƒê°ì´ë‚˜ ê°ì •ì´ ë“œì‹œëŠ”ì§€ ê¶ê¸ˆí•´ìš”.',
    'í˜¼ì ìˆëŠ” ì‹œê°„ì´ ë§ìœ¼ë©´ ì´ëŸ°ì €ëŸ° ìƒê°ë“¤ì´ ë§ì´ ë“¤ ìˆ˜ ìˆì–´ìš”. ì§€ê¸ˆ ê°€ì¥ ë§ˆìŒì— ê±¸ë¦¬ëŠ” ê²ƒì´ ë¬´ì—‡ì¸ê°€ìš”?',
    '1ì¸ ê°€êµ¬ë¡œ ìƒí™œí•˜ë©´ì„œ ëŠë¼ì‹œëŠ” ê°ì •ë“¤ì„ ì´í•´í•´ìš”. í‰ì†Œì— ë§ˆìŒì´ í˜ë“¤ ë•Œ ì–´ë–»ê²Œ ê·¹ë³µí•˜ë ¤ê³  ë…¸ë ¥í•˜ì‹œë‚˜ìš”?',
    'ì¶©ë¶„íˆ ê³µê°ì´ ë¼ìš”. í˜¼ìì„œ ëª¨ë“  ê²ƒì„ ì²˜ë¦¬í•˜ë‹¤ ë³´ë©´ ë•Œë¡œëŠ” ë²…ì°° ìˆ˜ ìˆì–´ìš”. ì§€ê¸ˆ ì´ ìˆœê°„ ê°€ì¥ í•„ìš”í•œ ê²ƒì´ ë¬´ì—‡ì¼ê¹Œìš”?',
    'ë§ˆìŒì„ ë‚˜ëˆ„ì–´ ì£¼ì…”ì„œ ê³ ë§ˆì›Œìš”. ì´ëŸ° ì´ì•¼ê¸°ë¥¼ í•˜ëŠ” ê²ƒ ìì²´ê°€ ìš©ê¸° ìˆëŠ” ì¼ì´ì—ìš”. ì–´ë–¤ ì‘ì€ ë³€í™”ë¼ë„ ì‹œë„í•´ë³¼ ìƒê°ì´ ìˆìœ¼ì‹ ê°€ìš”?'
  ]
  
  return generalResponses[Math.floor(Math.random() * generalResponses.length)]
}

export async function POST(request: NextRequest) {
  try {
    // API í‚¤ í™•ì¸ - ì—†ìœ¼ë©´ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ë™ì‘
    if (!process.env.OPENAI_API_KEY) {
      console.log('OpenAI API key not found, using simulation mode')
      
      const { messages } = await request.json()
      const lastMessage = messages[messages.length - 1]?.text || ''
      
      // ì‹œë®¬ë ˆì´ì…˜ëœ AI ì‘ë‹µ
      const simulatedResponse = getSimulatedResponse(lastMessage)
      
      // ì‹¤ì œ API í˜¸ì¶œì²˜ëŸ¼ ì•½ê°„ì˜ ì§€ì—° ì¶”ê°€
      await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000))
      
      return NextResponse.json({
        response: simulatedResponse,
        success: true,
        mode: 'simulation'
      })
    }

    const { messages } = await request.json()

    // ë©”ì‹œì§€ ìœ íš¨ì„± ê²€ì‚¬
    if (!messages || !Array.isArray(messages)) {
      return NextResponse.json(
        { error: 'ë©”ì‹œì§€ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' },
        { status: 400 }
      )
    }

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
    const systemMessage = {
      role: 'system' as const,
      content: SYSTEM_PROMPT
    }

    // ì‚¬ìš©ì ë©”ì‹œì§€ë§Œ í•„í„°ë§í•˜ê³  í¬ë§·íŒ…
    const formattedMessages = [
      systemMessage,
      ...messages.map((msg: any) => ({
        role: msg.isUser ? 'user' as const : 'assistant' as const,
        content: msg.text
      }))
    ]

    // OpenAI API í˜¸ì¶œ
    const completion = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: formattedMessages,
      max_tokens: 500,
      temperature: 0.7,
      presence_penalty: 0.1,
      frequency_penalty: 0.1,
    })

    const aiResponse = completion.choices[0]?.message?.content

    if (!aiResponse) {
      return NextResponse.json(
        { error: 'AI ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' },
        { status: 500 }
      )
    }

    return NextResponse.json({ 
      response: aiResponse,
      success: true 
    })

  } catch (error: any) {
    console.error('AI Chat API Error:', error)
    
    // OpenAI API ì—ëŸ¬ ì²˜ë¦¬
    if (error?.error?.type === 'insufficient_quota') {
      return NextResponse.json(
        { error: 'API ì‚¬ìš©ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' },
        { status: 429 }
      )
    }

    if (error?.error?.type === 'invalid_api_key') {
      return NextResponse.json(
        { error: 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' },
        { status: 401 }
      )
    }

    // ì¼ë°˜ì ì¸ ì—ëŸ¬
    return NextResponse.json(
      { 
        error: 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        details: process.env.NODE_ENV === 'development' ? error.message : undefined
      },
      { status: 500 }
    )
  }
}

